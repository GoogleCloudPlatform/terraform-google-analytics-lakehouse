# Subworkflow to upgrade all Dataplex Assets to Managed
# Subworkflow gets all lakes, then all zones within each lake, then all assets within each zone and upgrades
sub_upgrade_dataplex_assets:
    steps:
        - init:
            assign:
                - project_id: $${sys.get_env("GOOGLE_CLOUD_PROJECT_ID")}
                - location: $${sys.get_env("GOOGLE_CLOUD_LOCATION")}
                - zones: []
        - get_lakes:
            call: http.get
            args:
                url: $${"https://dataplex.googleapis.com/v1/projects/"+project_id+"/locations/"+location+"/lakes"}
                auth:
                    type: OAuth2
            result: Response
        - assign_lakes:
            assign:
                - response_lakes: $${Response.body.lakes}
        - get_zones:
            for:
                value: lake
                index: i
                in: $${response_lakes}
                steps:
                  - get_zones_in_lake:
                      call: http.get
                      args:
                          url: $${"https://dataplex.googleapis.com/v1/"+lake.name+"/zones"}
                          auth:
                              type: OAuth2
                      result: Response
                  - assign_zones:
                      assign:
                          - response_zones: $${Response.body.zones}

                  - save_zones:
                        for:
                          value: zone
                          index: j
                          in: $${response_zones}
                          steps:
                              - save_to_list:
                                  assign:
                                    - zones: $${list.concat(zones, zone)}
        - get_and_upgrade_all_assets:
            for:
                value: zone
                index: i
                in: $${zones}
                steps:
                  - get_assets_in_zone:
                      call: http.get
                      args:
                          url: $${"https://dataplex.googleapis.com/v1/"+zone.name+"/assets"}
                          auth:
                              type: OAuth2
                      result: Response
                  - check_for_assets:
                      switch:
                        - condition: $${not("assets" in Response.body)}
                          next: continue
                  - assign_assets:
                      assign:
                          - response_assets: $${Response.body.assets}
                  - upgrade_all_assets:
                        for:
                            value: asset
                            index: j
                            in: $${response_assets}
                            steps:
                              - upgrade_asset:
                                  call: http.patch
                                  args:
                                      url: $${"https://dataplex.googleapis.com/v1/"+asset.name+"?updateMask=resourceSpec.readAccessMode"}
                                      auth:
                                          type: OAuth2
                                      body:
                                          resourceSpec:
                                              readAccessMode: "MANAGED"

