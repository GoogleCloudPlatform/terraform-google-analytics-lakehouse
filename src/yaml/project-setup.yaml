# Copyright 2023 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# This defines the Google Workflow for the Analytics lakehouse Soultion: https://console.cloud.google.com/products/solutions/details/analytics-lakehouse
# This Workflow executes through Terraform. For Google Workflows executed via Terraform, variables are defined such that:
#
#     - Terraform environment variables are denoted by $
#     - Google Workflow variables are escaped via $$
#
# To modify this Workflow to stand alone (no Terraform):
#
#     - Replace vars in `main` -> `steps` -> `assign` with your own (or use https://cloud.google.com/workflows/docs/passing-runtime-arguments#gcloud)
#     - Change all $$ to $

main:
    params: []
    steps:
        - init:
            # Define local variables from terraform env variables
            assign:
                - temp_bucket_name: ${temp_bucket}
                - dataproc_service_account_name: ${dataproc_service_account}
                - provisioner_bucket_name: ${provisioner_bucket}
                - warehouse_bucket_name: ${warehouse_bucket}
        - sub_upgrade_dataplex_assets:
            call: sub_upgrade_dataplex_assets
            result: upgrade_dataplex_assets_output
        # TODO: change this to poll for BigQuery table creation
        - sub_wait_for_dataplex_discovery:
            call: sys.sleep
            args:
                seconds: 480
        - sub_create_tables:
            call: sub_create_tables
            result: create_tables_output
        - sub_create_iceberg:
            call: sub_create_iceberg
            args:
                temp_bucket_name: $${temp_bucket_name}
                dataproc_service_account_name: $${dataproc_service_account_name}
                provisioner_bucket_name: $${provisioner_bucket_name}
                warehouse_bucket_name: $${warehouse_bucket_name}
            result: create_iceberg_output
        - sub_create_taxonomy:
            call: sub_create_taxonomy
            result: create_taxonomy_output
